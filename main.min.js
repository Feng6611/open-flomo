let allMemos=[],tagStats=new Map,activeTag=null,currentPage=1;const PAGE_SIZE=20;let filteredMemos=[],memoCache={data:null,etag:null,timestamp:null};function getMemoTags(e){if(e.dataset.tags)return JSON.parse(e.dataset.tags);const t=new Set,n=e.querySelectorAll(".tag");if(n.length>0)n.forEach((e=>{const n=e.textContent.trim().replace(/^#/,"");n&&(t.add(n),n.includes("/")&&t.add(n.split("/")[0]))}));else{const n=/#([^\s#]+)/g;let o;const a=e.textContent;for(;null!==(o=n.exec(a));){const e=o[1].trim();e&&(t.add(e),e.includes("/")&&t.add(e.split("/")[0]))}}return Array.from(t)}function updateTagStats(e){tagStats.clear(),e.flat().forEach((e=>{tagStats.set(e,(tagStats.get(e)||0)+1);let t=e;for(;t.includes("/");)t=t.split("/").slice(0,-1).join("/"),tagStats.set(t,(tagStats.get(t)||0)+1)}))}function renderTagList(){const e={};function t(e,n){let o;o=1===n?"# "+e.tag:2===n?e.tag.replace(/^[^/]+\//,""):3===n?e.tag.replace(/^[^/]+\/[^/]+\//,""):e.tag;let a="";e.children&&e.children.length>0&&(a='<span class="toggle-arrow">▶</span>');let l=`<div class="tag-item level-${n} ${e.tag===activeTag?"active":""}" data-tag="${e.tag}">\n                        ${o}\n                        <span class="count">${e.count}</span>\n                        ${a}\n                    </div>`;return e.children&&e.children.length>0&&(l+='<div class="tag-children" style="display: none;">',e.children.forEach((e=>{l+=t(e,n+1)})),l+="</div>"),l}tagStats.forEach(((t,n)=>{const o=n.split("/");if(1===o.length)e[n]?e[n].count+=t:e[n]={tag:n,count:t,children:[]};else if(2===o.length){const a=o[0];e[a]||(e[a]={tag:a,count:0,children:[]}),e[a].children.push({tag:n,count:t,children:[]})}else if(3===o.length){const a=o[0],l=o[0]+"/"+o[1];e[a]||(e[a]={tag:a,count:0,children:[]});let i=e[a].children.find((e=>e.tag===l));i||(i={tag:l,count:0,children:[]},e[a].children.push(i)),i.children.push({tag:n,count:t})}})),filterConfig&&"asc"===filterConfig.tagListOrder?Object.values(e).sort(((e,t)=>e.count-t.count)):Object.values(e).sort(((e,t)=>t.count-e.count));let n=`<div class="tag-item all-tag ${activeTag?"":"active"}" data-tag="">\n                    全部笔记\n                    <span class="count">${allMemos.length}</span>\n                </div>`;Object.values(e).forEach((e=>{n+=t(e,1)}));const o=document.getElementById("tag-list");o.innerHTML=n,o.addEventListener("click",(e=>{if(e.target.classList.contains("toggle-arrow")){e.stopPropagation();const t=e.target.closest(".tag-item"),n=t?t.nextElementSibling:null;return void(n&&n.classList.contains("tag-children")&&("none"===n.style.display?(n.style.display="block",e.target.textContent="▼"):(n.style.display="none",e.target.textContent="▶")))}const t=e.target.closest(".tag-item");if(t&&o.contains(t)){const e=t.dataset.tag;activeTag=activeTag===e?null:e,filterMemosByTag(activeTag),o.querySelectorAll(".tag-item").forEach((e=>{e.classList.toggle("active",e.dataset.tag===activeTag)}))}}))}function filterMemosByTag(e){filteredMemos=e?allMemos.filter((t=>"exclude"===filterConfig.tagFilterMode?!t.tags.includes(e):t.tags.includes(e))).map((e=>e.html)):allMemos.map((e=>e.html)),renderPageOptimized(1,!0),document.getElementById("content").scrollTop=0}function processContent(){const e=document.getElementById("content");const t=e.querySelector(".memos");t&&function e(t){if(t.nodeType===Node.TEXT_NODE){const e=t.textContent,n=/#([^\s#]+)/g;let o,a=0;const l=document.createDocumentFragment();for(;null!==(o=n.exec(e));){o.index>a&&l.appendChild(document.createTextNode(e.slice(a,o.index)));const t=document.createElement("span");t.className="tag",t.textContent="#"+o[1],l.appendChild(t),a=n.lastIndex}a<e.length&&l.appendChild(document.createTextNode(e.slice(a))),l.childNodes.length>0&&t.parentNode.replaceChild(l,t)}else t.nodeType!==Node.ELEMENT_NODE||t.classList.contains("tag")||Array.from(t.childNodes).forEach((t=>e(t)))}(t);const n=document.createElement("div");n.innerHTML=e.innerHTML;const o=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1),a=/https?:\/\/[^\s<]+/g,l=[];let i;for(;i=o.nextNode();)l.push(i);l.forEach((e=>{const t=e.textContent;if(a.test(t)){const n=document.createDocumentFragment();let o,l=0;for(a.lastIndex=0;o=a.exec(t);){o.index>l&&n.appendChild(document.createTextNode(t.slice(l,o.index)));const e=document.createElement("a");e.href=o[0],e.textContent=o[0],e.target="_blank",e.rel="noopener noreferrer",n.appendChild(e),l=a.lastIndex}l<t.length&&n.appendChild(document.createTextNode(t.slice(l))),e.parentNode.replaceChild(n,e)}})),e.innerHTML=n.innerHTML}function updateSEOMetadata(){if(filterConfig&&filterConfig.seo){document.title=filterConfig.seo.title||document.title;let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=filterConfig.seo.description||"";let t=document.querySelector('meta[name="keywords"]');t||(t=document.createElement("meta"),t.name="keywords",document.head.appendChild(t)),t.content=filterConfig.seo.keywords||"";let n=document.querySelector('link[rel="canonical"]');if(n||(n=document.createElement("link"),n.rel="canonical",document.head.appendChild(n)),n.href=filterConfig.seo.canonicalUrl||window.location.href,filterConfig.icons){let e=document.querySelector('link[rel="icon"]');e||(e=document.createElement("link"),e.rel="icon",document.head.appendChild(e)),e.href=filterConfig.icons.favicon;let t=document.querySelector('link[rel="apple-touch-icon"]');t||(t=document.createElement("link"),t.rel="apple-touch-icon",document.head.appendChild(t)),t.href=filterConfig.icons.appleTouchIcon,filterConfig.icons.size&&(t.sizes=filterConfig.icons.size)}}}function renderPageOptimized(e,t=!1){currentPage=e;const n=20*(e-1),o=20*e,a=filteredMemos.slice(n,o),l=document.getElementById("content");if(t)l.innerHTML=`<div class="memos">${a.join("")}</div>`;else{l.querySelector(".memos").insertAdjacentHTML("beforeend",a.join(""))}"requestIdleCallback"in window?requestIdleCallback((()=>{processContent()}),{timeout:1e3}):requestAnimationFrame((()=>{processContent()}))}function handleScroll(){const{scrollTop:e,clientHeight:t,scrollHeight:n}=document.documentElement;e+t>=n-100&&20*currentPage<filteredMemos.length&&renderPageOptimized(currentPage+1)}function loadContent(e=!1){const t=document.getElementById("refresh-btn");t.classList.add("loading"),document.getElementById("content").innerHTML='<div class="loading">加载中...</div>',document.getElementById("tag-list").innerHTML='<div class="loading">加载中...</div>';const n=new Headers;!e&&memoCache.etag&&n.append("If-None-Match",memoCache.etag);const o=`${filterConfig.notesFileUrl}?v=${filterConfig.version}`;fetch(o,{headers:n}).then((e=>{const t=e.headers.get("ETag");if(t&&(memoCache.etag=t),304===e.status&&memoCache.data)return console.log("使用缓存数据"),Promise.resolve(memoCache.data);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.text()})).then((e=>{"string"==typeof e&&(memoCache.data=e,memoCache.timestamp=Date.now());processHtmlDocument((new DOMParser).parseFromString("string"==typeof e?e:memoCache.data,"text/html")),t.classList.remove("loading")})).catch((n=>{if(console.error("加载失败:",n),memoCache.data&&!e){console.log("加载失败，使用缓存数据");processHtmlDocument((new DOMParser).parseFromString(memoCache.data,"text/html")),t.classList.remove("loading");const e=document.createElement("div");return e.className="cache-notification",e.innerHTML="当前显示的是缓存数据",document.body.appendChild(e),void setTimeout((()=>e.remove()),3e3)}document.getElementById("content").innerHTML=`\n                <div style="color: #ff4444; padding: 20px; text-align: center;">\n                    加载失败，请刷新页面重试<br>\n                    <small style="color: #666;">${n.message}</small>\n                </div>\n            `,document.getElementById("tag-list").innerHTML='\n                <div style="color: #ff4444; padding: 20px; text-align: center;">\n                    加载失败\n                </div>\n            ',t.classList.remove("loading")}))}function processHtmlDocument(e){const t=e.querySelector(".memos");if(!t)throw new Error("未找到笔记内容");let n="";allMemos=Array.from(t.querySelectorAll(".memo")).map((e=>{const t=e.querySelector(".time"),o=t?new Date(t.textContent.trim().match(/\d{4}-\d{1,2}-\d{1,2}/)?.[0]||0):null,a=getMemoTags(e),l=e.querySelector(".content").innerHTML.replace(/src="file\//g,'src="flomo/file/'),i=`\n                <div class="memo" data-date="${o?o.getTime():"0"}" data-tags='${JSON.stringify(a)}'>\n                    <div class="time">${t?t.textContent:""}</div>\n                    <div class="content">${l}</div>\n                    <div class="files">${e.querySelector(".files")?.innerHTML||""}</div>\n                </div>\n            `;return n+=i,{html:i,date:o,tags:a}})).filter((({date:e})=>{if(!filterConfig.minDate)return!0;const t=new Date(filterConfig.minDate);return!e||e>=t})).filter((({tags:e})=>{if(!filterConfig.defaultTagFilter)return!0;const t=e.includes(filterConfig.defaultTagFilter);return"exclude"===filterConfig.tagFilterMode?!t:t})),updateTagStats(allMemos.map((e=>e.tags))),renderTagList(),filteredMemos=allMemos.map((e=>e.html)),renderPageOptimized(1,!0);const o=e.querySelector(".user");if(o){const e=o.querySelector(".name"),t=o.querySelector(".date"),n=e?e.innerText:"",a=t?t.innerText:"";document.querySelectorAll(".user").forEach((e=>{const t=e.querySelector(".name"),o=e.querySelector(".date");t&&(t.innerText=n),o&&(o.innerText=a)}))}}function refreshContent(){loadContent(!0)}function init(){updateSEOMetadata();document.getElementById("refresh-btn").addEventListener("click",refreshContent),document.getElementById("content").addEventListener("click",(function(e){const t=e.target.closest(".tag");if(t&&this.contains(t)){e.stopPropagation();const n=t.textContent.trim(),o=n.startsWith("#")?n.substring(1):n;activeTag=o,filterMemosByTag(o),document.querySelectorAll(".tag-item").forEach((e=>{e.classList.toggle("active",e.dataset.tag===o)}))}})),window.addEventListener("scroll",handleScroll),setInterval((()=>{document.hidden||memoCache.timestamp&&Date.now()-memoCache.timestamp<3e5||loadContent()}),3e5),document.addEventListener("visibilitychange",(()=>{!document.hidden&&memoCache.timestamp&&Date.now()-memoCache.timestamp>3e5&&loadContent()})),loadContent()}document.addEventListener("DOMContentLoaded",init);